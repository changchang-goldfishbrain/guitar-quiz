<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金魚腦的吉他樂理小補丁</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F5F1; /* Primary Background: Very light, soft off-white/cream */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #EDEAE5; /* Container Background: Slightly darker, but still light, warm grey/beige */
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2.5rem; /* Increased padding */
            max-width: 600px; /* Max width for larger screens */
            width: 100%; /* Full width on smaller screens */
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Spacing between sections */
        }
        .header {
            font-size: 2.25rem; /* Larger title */
            font-weight: 700;
            color: #4A3F35; /* Header/Strong Text: Dark brown/charcoal */
            margin-bottom: 1rem;
        }
        .key-selection-section, .quiz-section, .chord-selection-screen {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .key-grid, .chord-checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); /* Responsive grid for selection */
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .key-button {
            background-color: #6BA3A3; /* Accent Color 1 (Buttons - primary action): Muted teal/blue-green */
            color: white; /* Keep text white for contrast */
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem; /* Rounded buttons */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .key-button:hover {
            background-color: #5A8F8F; /* Hover for Accent 1: Slightly darker teal */
            transform: translateY(-2px);
        }
        .key-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        /* Specific style for the Mixed Practice button */
        .key-button.mixed-practice-button {
            background-color: #B5A6C4; /* Accent Color 2 (Mixed Practice button): Soft lavender/mauve */
            color: white; /* Changed to white as requested */
        }
        .key-button.mixed-practice-button:hover {
            background-color: #9E8CAE; /* Slightly darker shade on hover */
        }
        .quiz-question {
            font-size: 1.5rem; /* Larger question text */
            font-weight: 600;
            color: #4A3F35; /* Stronger text for questions */
            margin-bottom: 1.5rem;
        }
        .answer-options {
            display: grid;
            grid-template-columns: 1fr; /* Single column for options on all screens */
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .answer-button { /* For single-select radio buttons and matching tiles */
            background-color: #F5F2EE; /* Answer Buttons/Labels (default): Very light grey/beige */
            color: #6B6055; /* General Text: Medium brown/grey */
            padding: 0.85rem 1.25rem;
            border-radius: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: 1px solid #DEDBD6; /* Subtle border, complementary to background */
        }
        .answer-button:hover {
            background-color: #E8E5E0; /* Hover for Answer Buttons: Slightly darker light grey */
            transform: translateY(-1px);
        }
        .answer-button.correct {
            background-color: #5C8D89; /* Correct Feedback/Button: Muted forest green */
            color: white;
            border-color: #5C8D89;
        }
        .answer-button.incorrect {
            background-color: #C97C5D; /* Incorrect Feedback/Button: Muted terracotta/rust */
            color: white;
            border-color: #C97C5D;
        }

        /* Styles for multi-select checkboxes (used in old multi-select quiz and new chord selection) */
        .chord-selection-label, .answer-label {
            display: block; /* Make label take full width */
            background-color: #F5F2EE; /* Answer Buttons/Labels (default): Very light grey/beige */
            color: #6B6055; /* General Text: Medium brown/grey */
            padding: 0.85rem 1.25rem;
            border-radius: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: 1px solid #DEDBD6;
            text-align: left; /* Align text left within the label */
            display: flex; /* Use flex to align checkbox and text */
            align-items: center;
            gap: 0.5rem; /* Space between checkbox and text */
        }
        .chord-selection-label:hover, .answer-label:hover {
            background-color: #E8E5E0;
            transform: translateY(-1px);
        }
        .chord-selection-label.selected { /* For chord selection, highlight selected */
            background-color: #6BA3A3; /* Use Accent Color 1 for selected checkboxes */
            color: white;
            border-color: #6BA3A3;
        }
        .answer-label.correct {
            background-color: #5C8D89;
            color: white;
            border-color: #5C8D89;
        }
        .answer-label.incorrect {
            background-color: #C97C5D;
            color: white;
            border-color: #C97C5D;
        }
        /* For checkboxes themselves */
        .chord-selection-checkbox, .answer-checkbox {
            width: 20px; /* Make checkbox larger for touch */
            height: 20px;
            flex-shrink: 0; /* Prevent checkbox from shrinking */
            accent-color: #6BA3A3; /* Custom color for checked state */
        }
        .answer-label.missing-correct { /* Style for correct options user missed */
            border-color: #E09F3E; /* Use the orange accent for this */
            background-color: #FCE9B0; /* Lighter version of the orange accent */
        }


        .feedback {
            margin-top: 1rem;
            font-size: 1.1rem;
            font-weight: 500;
            color: #4A3F35; /* Darker text for feedback */
            min-height: 40px; /* Ensure space for feedback */
        }
        .feedback.correct-text {
            color: #5C8D89; /* Green for correct */
        }
        .feedback.incorrect-text {
            color: #C97C5D; /* Red for incorrect */
        }
        .score-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: #4A3F35; /* Darker text for score */
            margin-top: 1rem;
        }
        .start-matching-button {
            background-color: #E09F3E; /* Next/Start Matching Button: A warm, inviting orange/brown */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 1.5rem;
        }
        .start-matching-button:hover {
            background-color: #C88A2B; /* Darker warm orange */
            transform: translateY(-2px);
        }
        .start-matching-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .next-button {
            background-color: #E09F3E; /* Next/Start Matching Button: A warm, inviting orange/brown */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 1.5rem;
        }
        .next-button:hover {
            background-color: #C88A2B; /* Darker warm orange */
            transform: translateY(-2px);
        }
        .next-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .hidden {
            display: none;
        }

        /* New styles for matching game tiles */
        .matching-tile.selected {
            border: 2px solid #6BA3A3; /* Blue border for selected, using Accent 1 */
            transform: scale(1.02);
            box-shadow: 0 0 10px rgba(107, 163, 163, 0.5); /* Shadow matching Accent 1 */
        }
        .matching-tile.correct {
            background-color: #5C8D89; /* Green for correct match */
            color: white;
            border-color: #5C8D89;
            pointer-events: none; /* Disable clicks on matched tiles */
        }
        .matching-tile.incorrect {
            background-color: #C97C5D; /* Red for incorrect match */
            color: white;
            border-color: #C97C5D;
        }
        /* Layout for matching game columns */
        .matching-game-columns {
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align columns at the top */
            gap: 1.5rem; /* Space between columns */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .matching-column {
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Space between tiles in a column */
            width: 48%; /* Each column takes half width, with gap */
            min-width: 150px; /* Minimum width to prevent squishing */
        }
        
        /* [EDIT] Responsive adjustments for smaller screens */
        @media (max-width: 520px) {
            .matching-game-columns {
                gap: 0.75rem; /* Reduce gap between columns to save space */
            }
            .matching-column {
                min-width: 0;
                flex: 1;
                width: auto;
            }
            .matching-tile.answer-button {
                padding: 0.75rem 0.5rem; /* Adjust padding for smaller buttons */
                font-size: 0.9rem; /* Make font smaller */
            }
        }
        /* New style for text input field */
        .answer-input {
            margin-bottom: 1.5rem; /* Space below the input field */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">金魚腦的吉他樂理小補丁</div>

        <div id="key-selection" class="key-selection-section">
            <p class="text-lg text-gray-700" style="color: #6B6055;">請選擇一個調性開始測驗：</p>
            <div class="key-grid">
                <button class="key-button" data-key="C">C大調</button>
                <button class="key-button" data-key="G">G大調</button>
                <button class="key-button" data-key="D">D大調</button>
                <button class="key-button" data-key="A">A大調</button>
                <button class="key-button" data-key="E">E大調</button>
                <button class="key-button" data-key="F">F大調</button>
                <button class="key-button" data-key="B">B大調</button>
                <button class="key-button mixed-practice-button" data-key="MixedMatchingGame">混合練習</button>
                <button class="key-button mixed-practice-button" data-key="ChordComponentsQuiz">和弦組成音</button> </div>
        </div>

        <div id="chord-selection-screen" class="chord-selection-screen hidden">
            <p class="text-lg text-gray-700" style="color: #6B6055;">請選擇要練習的和弦根音：</p>
            <div class="chord-checkbox-grid" id="chord-type-options">
                </div>
            <button class="start-matching-button" id="start-mixed-matching-button">開始連連看</button>
        </div>

        <div id="quiz-game" class="quiz-section hidden">
            <p class="text-xl font-semibold text-gray-800" id="current-key-display"></p>
            <p class="text-lg mb-4 p-2 rounded-md" style="background-color: #FCE9B0; color: #6B6055;" id="selected-roots-display"></p>
            <div class="quiz-question" id="question-text"></div>
            <div class="answer-options" id="answer-buttons"></div>
            <div class="feedback" id="feedback-text"></div>
            <div class="score-display" id="score-display">分數: 0 / 0</div>
            <button class="next-button hidden" id="next-button">下一題</button>
            <button class="next-button hidden" id="restart-button">重新開始</button>
        </div>
    </div>

    <script>
        // Quiz data for various keys
        const quizData = {
            "C": {
                "keyName": "C大調",
                "chordMap": {
                    "1": "C", "2m": "Dm", "3m": "Em", "4": "F", "5": "G", "6m": "Am", "7dim": "Bdim"
                },
                // Removed scaleNotes if not directly used for chord components, as `chordComponents` is more precise
                "chordComponents": { // Added specific chord components for different chord types
                    "C": ["C", "E", "G"], "Dm": ["D", "F", "A"], "Em": ["E", "G", "B"], "F": ["F", "A", "C"],
                    "G": ["G", "B", "D"], "Am": ["A", "C", "E"], "Bdim": ["B", "D", "F"],
                    "C7": ["C", "E", "G", "Bb"], "G7": ["G", "B", "D", "F"], "D7": ["D", "F#", "A", "C"],
                    "A7": ["A", "C#", "E", "G"], "E7": ["E", "G#", "B", "D"], "F7": ["F", "A", "C", "Eb"],
                    "Bb7": ["Bb", "D", "F", "Ab"], "B7": ["B", "D#", "F#", "A"]
                    // Add other common chords if needed, e.g., Cm, Dm, etc., if you want to quiz them
                    // Example: "Cm": ["C", "Eb", "G"], "Ddim": ["D", "F", "Ab"]
                }
            },
            "G": {
                "keyName": "G大調",
                "chordMap": {
                    "1": "G", "2m": "Am", "3m": "Bm", "4": "C", "5": "D", "6m": "Em", "7dim": "F#dim"
                },
                "chordComponents": {
                    "G": ["G", "B", "D"], "Am": ["A", "C", "E"], "Bm": ["B", "D", "F#"], "C": ["C", "E", "G"],
                    "D": ["D", "F#", "A"], "Em": ["E", "G", "B"], "F#dim": ["F#", "A", "C"],
                    "G7": ["G", "B", "D", "F"], "D7": ["D", "F#", "A", "C"], "C7": ["C", "E", "G", "Bb"],
                    "F#m": ["F#", "A", "C#"] // Example for other chords if they might appear in questions
                }
            },
            "D": {
                "keyName": "D大調",
                "chordMap": {
                    "1": "D", "2m": "Em", "3m": "F#m", "4": "G", "5": "A", "6m": "Bm", "7dim": "C#dim"
                },
                "chordComponents": {
                    "D": ["D", "F#", "A"], "Em": ["E", "G", "B"], "F#m": ["F#", "A", "C#"], "G": ["G", "B", "D"],
                    "A": ["A", "C#", "E"], "Bm": ["B", "D", "F#"], "C#dim": ["C#", "E", "G"],
                    "D7": ["D", "F#", "A", "C"], "A7": ["A", "C#", "E", "G"]
                }
            },
            "A": {
                "keyName": "A大調",
                "chordMap": {
                    "1": "A", "2m": "Bm", "3m": "C#m", "4": "D", "5": "E", "6m": "F#m", "7dim": "G#dim"
                },
                "chordComponents": {
                    "A": ["A", "C#", "E"], "Bm": ["B", "D", "F#"], "C#m": ["C#", "E", "G#"], "D": ["D", "F#", "A"],
                    "E": ["E", "G#", "B"], "F#m": ["F#", "A", "C#"], "G#dim": ["G#", "B", "D"],
                    "A7": ["A", "C#", "E", "G"], "E7": ["E", "G#", "B", "D"]
                }
            },
            "E": {
                "keyName": "E大調",
                "chordMap": {
                    "1": "E", "2m": "F#m", "3m": "G#m", "4": "A", "5": "B", "6m": "C#m", "7dim": "D#dim"
                },
                "chordComponents": {
                    "E": ["E", "G#", "B"], "F#m": ["F#", "A", "C#"], "G#m": ["G#", "B", "D#"], "A": ["A", "C#", "E"],
                    "B": ["B", "D#", "F#"], "C#m": ["C#", "E", "G#"], "D#dim": ["D#", "F#", "A"],
                    "E7": ["E", "G#", "B", "D"], "B7": ["B", "D#", "F#", "A"]
                }
            },
            "F": {
                "keyName": "F大調",
                "chordMap": {
                    "1": "F", "2m": "Gm", "3m": "Am", "4": "Bb",
                    "5": "C", "6m": "Dm", "7dim": "Edim"
                },
                "chordComponents": {
                    "F": ["F", "A", "C"], "Gm": ["G", "Bb", "D"], "Am": ["A", "C", "E"], "Bb": ["Bb", "D", "F"],
                    "C": ["C", "E", "G"], "Dm": ["D", "F", "A"], "Edim": ["E", "G", "Bb"],
                    "F7": ["F", "A", "C", "Eb"], "C7": ["C", "E", "G", "Bb"]
                }
            },
            "B": {
                "keyName": "B大調",
                "chordMap": {
                    "1": "B", "2m": "C#m", "3m": "D#m", "4": "E", "5": "F#", "6m": "G#m", "7dim": "A#dim"
                },
                "chordComponents": {
                    "B": ["B", "D#", "F#"], "C#m": ["C#", "E", "G#"], "D#m": ["D#", "F#", "A#"], "E": ["E", "G#", "B"],
                    "F#": ["F#", "A#", "C#"], "G#m": ["G#", "B", "D#"], "A#dim": ["A#", "C#", "E"],
                    "B7": ["B", "D#", "F#", "A"], "F#7": ["F#", "A#", "C#", "E"]
                }
            }
        };

        // All chords with components for the "和弦組成音" quiz.
        // This array gathers all available chords from the `chordComponents` of all keys.
        const allComponentQuizChords = [];
        for (const key in quizData) {
            if (quizData[key].chordComponents) {
                for (const chordName in quizData[key].chordComponents) {
                    allComponentQuizChords.push({
                        chord: chordName,
                        components: quizData[key].chordComponents[chordName]
                    });
                }
            }
        }
        // Ensure unique chords if a chord name appears in multiple keys (e.g., C in C major, C in F major)
        // We'll use a Set to store unique chord names and then map back to objects.
        const uniqueComponentQuizChords = Array.from(new Set(allComponentQuizChords.map(item => item.chord)))
            .map(chordName => allComponentQuizChords.find(item => item.chord === chordName));


        let selectedNumTile = null;
        let selectedChordTile = null;
        let matchedPairsCount = 0;
        let matchingGamePairs = []; 
        let selectedRootLettersForMixedMatching = []; 

        let currentKey = '';
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let totalQuestionsAttempted = 0;
        let quizActive = false;
        let quizMode = ''; // Added to differentiate between 'single-select', 'text-input-components' and 'matching'

        // Get DOM elements
        const keySelectionSection = document.getElementById('key-selection');
        const quizGameSection = document.getElementById('quiz-game');
        const chordSelectionScreen = document.getElementById('chord-selection-screen'); 
        const chordTypeOptionsContainer = document.getElementById('chord-type-options'); 
        const startMixedMatchingButton = document.getElementById('start-mixed-matching-button'); 

        const currentKeyDisplay = document.getElementById('current-key-display');
        const selectedRootsDisplay = document.getElementById('selected-roots-display'); 
        const questionText = document.getElementById('question-text');
        const answerButtonsContainer = document.getElementById('answer-buttons');
        const feedbackText = document.getElementById('feedback-text');
        const scoreDisplay = document.getElementById('score-display');
        const nextButton = document.getElementById('next-button');
        const restartButton = document.getElementById('restart-button');
        const keyButtons = document.querySelectorAll('.key-button');

        // Helper function to get the base letter of a chord (e.g., "C" from "C", "Dm", "C#m", "Bb")
        function getChordBaseLetter(chordName) {
            return chordName.charAt(0);
        }

        // Function to shuffle an array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Function to generate quiz questions for a given key (single/multi-select modes only)
        function generateQuizQuestions(key) {
            const questions = [];
            const allKeys = Object.keys(quizData);

            // --- Type: 和弦組合成音模式 (Chord Components Quiz) ---
            // This mode takes random chords from the `uniqueComponentQuizChords`
            if (key === 'ChordComponentsQuiz') {
                const quizChords = shuffleArray([...uniqueComponentQuizChords]); // Create a shuffled copy
                quizChords.forEach(item => {
                    questions.push({
                        question: `請輸入 ${item.chord} 的所有組成音 (用空格隔開)`,
                        correctAnswer: item.components.map(note => note.trim()).join(' ').toLowerCase(), // Store as lowercase space-separated
                        type: 'text-input-components'
                    });
                });
                return questions; // Return only these questions for this mode
            }

            // --- Below are existing key-specific quiz types ---
            const chordMap = quizData[key].chordMap;
            const chords = Object.keys(chordMap);

            // Type 1: "在[Key]大調中，'數字表示' 代表哪個和弦？"
            chords.forEach(numNotation => {
                const correctAnswerChordName = chordMap[numNotation];
                questions.push({
                    question: `在${quizData[key].keyName}中，「${numNotation}」代表哪個和弦？`,
                    correctAnswer: correctAnswerChordName,
                    options: shuffleArray(Object.values(chordMap).filter(c => c !== correctAnswerChordName).slice(0, 3).concat(correctAnswerChordName)),
                    type: 'single-select'
                });
            });
            
            // Type 2: "以下哪組數字和弦表示法，完全符合[Key]大調的順階和弦？"
            const correctSequence = Object.keys(chordMap).join(', ');
            const incorrectSequences = [
                chords.map(c => c.replace('m', '').replace('dim', '')).join(', '),
                chords.map((c, i) => i === 2 ? c.replace('m', '') : c).join(', '),
                chords.map((c, i) => i === 5 ? c.replace('m', '') : c).join(', ')
            ].filter(seq => seq !== correctSequence);

            questions.push({
                question: `以下哪組數字和弦表示法，完全符合${quizData[key].keyName}的順階和弦？`,
                correctAnswer: correctSequence,
                options: shuffleArray([correctSequence, ...incorrectSequences.slice(0, 3)]),
                type: 'single-select'
            });

            // Type 3: "如果一個歌曲的和弦進行是「1 - 4 - 5 - 1」，請問這對應到[Key]大調的哪些和弦？"
            const progressionNum = "1 - 4 - 5 - 1";
            const progressionChordsCorrect = `${chordMap["1"]} - ${chordMap["4"]} - ${chordMap["5"]} - ${chordMap["1"]}`;
            const progressionOptions = new Set();
            progressionOptions.add(progressionChordsCorrect);

            const incorrectProgression1 = `${chordMap["1"]} - ${chordMap["2m"]} - ${chordMap["3m"]} - ${chordMap["1"]}`;
            const incorrectProgression2 = `${chordMap["1"]} - ${chordMap["5"]} - `${chordMap["4"]} - ${chordMap["1"]}`;
            const incorrectProgression3 = `${chordMap["1"]} - ${chordMap["6m"]} - ${chordMap["5"]} - ${chordMap["1"]}`;

            progressionOptions.add(incorrectProgression1);
            progressionOptions.add(incorrectProgression2);
            progressionOptions.add(incorrectProgression3);

            questions.push({
                question: `如果一個歌曲的和弦進行是「${progressionNum}」，請問這對應到${quizData[key].keyName}的哪些和弦？`,
                correctAnswer: progressionChordsCorrect,
                options: shuffleArray(Array.from(progressionOptions).slice(0, 4)),
                type: 'single-select'
            });

            // Type 4: "在[Key]大調中，哪個數字表示的和弦是小三和弦？"
            const minorChordsNum = Object.keys(chordMap).filter(num => num.includes('m'));
            const correctMinorNum = minorChordsNum[Math.floor(Math.random() * minorChordsNum.length)];
            const minorOptions = new Set();
            minorOptions.add(correctMinorNum);

            const majorOrDimChordsNum = Object.keys(chordMap).filter(num => !num.includes('m'));
            while (minorOptions.size < 4) {
                const randomOption = majorOrDimChordsNum[Math.floor(Math.random() * majorOrDimChordsNum.length)];
                if (randomOption && !minorOptions.has(randomOption)) {
                    minorOptions.add(randomOption);
                } else if (majorOrDimChordsNum.length === 0 && minorOptions.size < 4) {
                    const randomExisting = chords[Math.floor(Math.random() * chords.length)];
                    if (!minorOptions.has(randomExisting)) {
                        minorOptions.add(randomExisting);
                    }
                }
            }

            questions.push({
                question: `在${quizData[key].keyName}中，哪個數字表示的和弦是小三和弦？`,
                correctAnswer: correctMinorNum,
                options: shuffleArray(Array.from(minorOptions)),
                type: 'single-select'
            });

            // Type 5: Identify the chord sequence for a given key based on the numerical pattern.
            const correctChordSequenceForCurrentKey = Object.values(chordMap).join(', ');

            const optionsForType5 = new Set();
            optionsForType5.add(correctChordSequenceForCurrentKey);

            const otherKeys = allKeys.filter(k => k !== key);
            shuffleArray(otherKeys);

            for (let i = 0; i < Math.min(3, otherKeys.length); i++) {
                const randomOtherKey = otherKeys[i];
                const randomOtherChordMap = quizData[randomOtherKey].chordMap;
                const randomOtherChordSequence = Object.values(randomOtherChordMap).join(', ');
                if (randomOtherChordSequence !== correctChordSequenceForCurrentKey && optionsForType5.size < 4) {
                    optionsForType5.add(randomOtherChordSequence);
                }
            }
            while (optionsForType5.size < 4) {
                const randomOtherKey = allKeys[Math.floor(Math.random() * allKeys.length)];
                const randomOtherChordMap = quizData[randomOtherKey].chordMap;
                const randomOtherChordSequence = Object.values(randomOtherChordMap).join(', ');
                optionsForType5.add(randomOtherChordSequence);
            }

            questions.push({
                question: `在${quizData[key].keyName}中，以下哪組和弦符合「1, 2m, 3m, 4, 5, 6m, 7dim」這個順階和弦模式？`,
                correctAnswer: correctChordSequenceForCurrentKey,
                options: shuffleArray(Array.from(optionsForType5)),
                type: 'single-select'
            });

            // Type 6: Identify the correct numerical pattern for a given key's diatonic chords.
            const correctNumericalPattern = Object.keys(chordMap).join(', ');
            const optionsForType6 = new Set();
            optionsForType6.add(correctNumericalPattern);

            const incorrectPattern1 = chords.map(c => c.replace('m', '').replace('dim', '')).join(', ');
            const incorrectPattern2 = chords.map((c, i) => i === 1 ? c.replace('m', '') : c).join(', ');
            const incorrectPattern3 = chords.map((c, i) => i === 4 ? `${c}m` : c).join(', ');

            if (incorrectPattern1 !== correctNumericalPattern) optionsForType6.add(incorrectPattern1);
            if (incorrectPattern2 !== correctNumericalPattern) optionsForType6.add(incorrectPattern2);
            if (incorrectPattern3 !== correctNumericalPattern) optionsForType6.add(incorrectPattern3);

            while (optionsForType6.size < 4) {
                const randomIncorrectIndex = Math.floor(Math.random() * chords.length);
                let randomIncorrectPattern = chords.map((c, i) => {
                    if (i === randomIncorrectIndex) {
                        if (c.includes('m')) return c.replace('m', '');
                        if (c.includes('dim')) return c.replace('dim', '');
                        return `${c}m`;
                    }
                    return c;
                }).join(', ');
                if (randomIncorrectPattern !== correctNumericalPattern) {
                    optionsForType6.add(randomIncorrectPattern);
                }
            }

            questions.push({
                question: `在${quizData[key].keyName}中，其完整的順階和弦數字表示法是什麼？`,
                correctAnswer: correctNumericalPattern,
                options: shuffleArray(Array.from(optionsForType6)),
                type: 'single-select'
            });

            return shuffleArray(questions);
        }

        // Function to populate chord selection checkboxes for Mixed Matching Game
        function populateChordSelection() {
            chordTypeOptionsContainer.innerHTML = '';
            const commonRootNotes = ["C", "D", "E", "F", "G", "A", "B", "Bb"]; // Added Bb for broader chord types

            commonRootNotes.forEach(note => {
                const label = document.createElement('label');
                label.classList.add('chord-selection-label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = note; 
                checkbox.classList.add('chord-selection-checkbox');
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        label.classList.add('selected');
                    } else {
                        label.classList.remove('selected');
                    }
                });
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(note));
                chordTypeOptionsContainer.appendChild(label);
            });
        }

        // Function to start any matching game mode
        function startMatchingMode(modeKey, selectedRootLetters = null) {
            currentKey = modeKey;
            currentKeyDisplay.textContent = '混合練習連連看'; 
            currentKeyDisplay.classList.remove('text-xl', 'font-semibold', 'text-gray-800');
            currentKeyDisplay.classList.add('text-3xl', 'font-bold', 'bg-[#F7D67D]', 'p-2', 'rounded-lg', 'inline-block');
            currentKeyDisplay.style.color = '#4A3F35'; 

            chordSelectionScreen.classList.add('hidden'); 
            keySelectionSection.classList.add('hidden'); 
            quizGameSection.classList.remove('hidden');
            restartButton.classList.add('hidden');
            nextButton.classList.add('hidden'); 

            score = 0;
            totalQuestionsAttempted = 0; 
            matchedPairsCount = 0;
            selectedNumTile = null;
            selectedChordTile = null;
            quizActive = true; 
            quizMode = 'matching'; // Set quiz mode

            const success = generateMatchingPairs(selectedRootLetters);
            if (success) { 
                displayMatchingGame();
                updateScoreDisplay();
            } else {
                updateScoreDisplay();
            }
        }

        // Function to generate pairs for the matching game based on selected root letters
        function generateMatchingPairs(selectedRootLetters = null) {
            const potentialPairs = []; 

            if (selectedRootLetters && selectedRootLetters.length > 0) {
                selectedRootLetters.forEach(rootLetter => {
                    // Find relevant keys that contain this root letter in their chordMap (as root of 1, 4, 5, etc.)
                    // Or, for simplicity, just get chords *starting* with that root letter from all available chordComponents.
                    // This logic needs to be careful: a rootLetter like "C" means "C chord family".
                    // Let's iterate through all keys' chordMap to find chords where the actual chordName starts with the selected rootLetter.
                    for (const keyId in quizData) {
                        const currentChordMap = quizData[keyId].chordMap;
                        for (const numNotation in currentChordMap) {
                            const chordName = currentChordMap[numNotation];
                            if (getChordBaseLetter(chordName) === rootLetter && !potentialPairs.some(p => p.chord === chordName && p.num === numNotation)) {
                                potentialPairs.push({
                                    num: numNotation,
                                    chord: chordName,
                                    id: `${numNotation}-${chordName}-${keyId}` // Use keyId to make ID truly unique across keys
                                });
                            }
                        }
                    }
                });
            } else {
                questionText.textContent = '請至少選擇一個和弦根音！';
                answerButtonsContainer.innerHTML = '';
                restartButton.classList.remove('hidden');
                quizActive = false;
                return false;
            }
            
            // Limit pairs to a reasonable number, e.g., 10-15 unique pairs for a manageable game
            matchingGamePairs = shuffleArray(potentialPairs).slice(0, 15); // Take up to 15 pairs
            if (matchingGamePairs.length === 0) {
                questionText.textContent = '選定的和弦根音沒有可用的配對組合。請選擇其他根音。';
                answerButtonsContainer.innerHTML = '';
                restartButton.classList.remove('hidden');
                quizActive = false;
                return false;
            }
            return true;
        }

        // Function to display the matching game
        function displayMatchingGame() {
            answerButtonsContainer.innerHTML = ''; // Clear previous content
            feedbackText.textContent = '';
            selectedRootsDisplay.textContent = `選定的和弦根音：${selectedRootLettersForMixedMatching.join(', ')}`;

            // Create two columns for matching
            const numColumn = document.createElement('div');
            numColumn.classList.add('matching-column');
            const chordColumn = document.createElement('div');
            chordColumn.classList.add('matching-column');

            const numTiles = [];
            const chordTiles = [];

            matchingGamePairs.forEach(pair => {
                // Create num tile
                const numTile = document.createElement('button');
                numTile.classList.add('answer-button', 'matching-tile');
                numTile.textContent = pair.num;
                numTile.dataset.id = pair.id;
                numTile.dataset.type = 'num';
                numTiles.push(numTile);

                // Create chord tile
                const chordTile = document.createElement('button');
                chordTile.classList.add('answer-button', 'matching-tile');
                chordTile.textContent = pair.chord;
                chordTile.dataset.id = pair.id;
                chordTile.dataset.type = 'chord';
                chordTiles.push(chordTile);
            });

            shuffleArray(numTiles).forEach(tile => numColumn.appendChild(tile));
            shuffleArray(chordTiles).forEach(tile => chordColumn.appendChild(tile));

            const gameColumnsContainer = document.createElement('div');
            gameColumnsContainer.classList.add('matching-game-columns');
            gameColumnsContainer.appendChild(numColumn);
            gameColumnsContainer.appendChild(chordColumn);
            answerButtonsContainer.appendChild(gameColumnsContainer);

            // Add event listeners for matching tiles
            document.querySelectorAll('.matching-tile').forEach(tile => {
                tile.addEventListener('click', handleMatchingTileClick);
            });

            questionText.textContent = '點擊左側數字和右側和弦來配對：';
        }

        // Handle clicks for matching game tiles
        function handleMatchingTileClick(event) {
            if (!quizActive) return; // Prevent clicks if quiz is not active (e.g., after completion)

            const clickedTile = event.target;
            if (clickedTile.classList.contains('correct') || clickedTile.classList.contains('incorrect')) {
                return; // Do not allow clicking already matched/incorrectly tried tiles
            }

            // Deselect previous tile of the same type if clicked again
            if (clickedTile.dataset.type === 'num') {
                if (selectedNumTile === clickedTile) {
                    selectedNumTile.classList.remove('selected');
                    selectedNumTile = null;
                    return;
                }
                if (selectedNumTile) {
                    selectedNumTile.classList.remove('selected');
                }
                selectedNumTile = clickedTile;
            } else { // type is 'chord'
                if (selectedChordTile === clickedTile) {
                    selectedChordTile.classList.remove('selected');
                    selectedChordTile = null;
                    return;
                }
                if (selectedChordTile) {
                    selectedChordTile.classList.remove('selected');
                }
                selectedChordTile = clickedTile;
            }

            clickedTile.classList.add('selected');
            feedbackText.textContent = ''; // Clear previous feedback

            if (selectedNumTile && selectedChordTile) {
                // Check for a match
                if (selectedNumTile.dataset.id === selectedChordTile.dataset.id) {
                    // Correct match
                    selectedNumTile.classList.add('correct');
                    selectedChordTile.classList.add('correct');
                    feedbackText.textContent = '正確！';
                    feedbackText.classList.remove('incorrect-text');
                    feedbackText.classList.add('correct-text');
                    score++;
                    matchedPairsCount++;
                    updateScoreDisplay();

                    selectedNumTile.classList.remove('selected');
                    selectedChordTile.classList.remove('selected');
                    selectedNumTile = null;
                    selectedChordTile = null;

                    if (matchedPairsCount === matchingGamePairs.length) {
                        endGame();
                    }
                } else {
                    // Incorrect match
                    feedbackText.textContent = '不正確，再試試看！';
                    feedbackText.classList.remove('correct-text');
                    feedbackText.classList.add('incorrect-text');

                    // Briefly show incorrect, then remove selected state
                    selectedNumTile.classList.add('incorrect');
                    selectedChordTile.classList.add('incorrect');

                    setTimeout(() => {
                        selectedNumTile.classList.remove('selected', 'incorrect');
                        selectedChordTile.classList.remove('selected', 'incorrect');
                        selectedNumTile = null;
                        selectedChordTile = null;
                        feedbackText.textContent = ''; // Clear feedback after showing error
                    }, 800);
                }
                totalQuestionsAttempted++; // Count each match attempt
            }
        }

        // Function to display the current question (for single-select and text-input quizzes)
        function displayQuestion() {
            quizActive = true;
            feedbackText.textContent = '';
            answerButtonsContainer.innerHTML = '';
            nextButton.classList.add('hidden');
            restartButton.classList.add('hidden');
            selectedRootsDisplay.classList.add('hidden'); // Hide selected roots display for all non-matching modes

            if (currentQuestionIndex < currentQuestions.length) {
                const question = currentQuestions[currentQuestionIndex];
                questionText.textContent = question.question;
                
                // Adjust display for standard quiz vs. mixed matching vs. chord components
                if (quizMode === 'text-input-components') {
                    currentKeyDisplay.textContent = '和弦組成音測驗';
                    currentKeyDisplay.classList.remove('text-xl', 'font-semibold', 'text-gray-800');
                    currentKeyDisplay.classList.add('text-3xl', 'font-bold', 'bg-[#F7D67D]', 'p-2', 'rounded-lg', 'inline-block');
                    currentKeyDisplay.style.color = '#4A3F35';
                } else { // For single-select (key-based quizzes)
                    currentKeyDisplay.textContent = `${quizData[currentKey].keyName} 順階和弦測驗`; 
                    currentKeyDisplay.classList.remove('text-3xl', 'font-bold', 'bg-[#F7D67D]', 'p-2', 'rounded-lg', 'inline-block');
                    currentKeyDisplay.classList.add('text-xl', 'font-semibold', 'text-gray-800'); 
                }

                if (question.type === 'single-select') {
                    question.options.forEach(option => {
                        const button = document.createElement('button');
                        button.classList.add('answer-button');
                        button.textContent = option;
                        button.addEventListener('click', () => checkAnswer(option, question.correctAnswer));
                        answerButtonsContainer.appendChild(button);
                    });
                } else if (question.type === 'text-input-components') {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.classList.add('answer-input', 'p-2', 'border', 'border-gray-300', 'rounded-md', 'w-full', 'text-center', 'text-lg');
                    input.placeholder = '請輸入組成音，用空格隔開'; 
                    answerButtonsContainer.appendChild(input);

                    const submitButton = document.createElement('button');
                    submitButton.classList.add('next-button', 'mt-4'); 
                    submitButton.textContent = '提交答案';
                    submitButton.onclick = () => checkTextInputAnswer(input.value, question.correctAnswer);
                    answerButtonsContainer.appendChild(submitButton);

                    // Focus on the input field
                    setTimeout(() => input.focus(), 100);
                }
            } else {
                endGame();
            }
        }

        // Check answer for single-select questions
        function checkAnswer(selectedOption, correctAnswer) {
            if (!quizActive) return; 
            quizActive = false; 

            totalQuestionsAttempted++;
            const allButtons = answerButtonsContainer.querySelectorAll('.answer-button');
            let isCorrect = (selectedOption === correctAnswer);

            allButtons.forEach(button => {
                if (button.textContent === correctAnswer) {
                    button.classList.add('correct');
                } else if (button.textContent === selectedOption && selectedOption !== correctAnswer) {
                    button.classList.add('incorrect');
                }
                button.disabled = true; 
            });

            if (isCorrect) {
                score++;
                feedbackText.textContent = '✓ 正確！';
                feedbackText.classList.remove('incorrect-text');
                feedbackText.classList.add('correct-text');
            } else {
                feedbackText.textContent = `✗ 不正確，正確答案是：${correctAnswer}`;
                feedbackText.classList.remove('correct-text');
                feedbackText.classList.add('incorrect-text');
            }
            
            // Auto-advance to next question after a short delay
            setTimeout(() => {
                currentQuestionIndex++;
                updateScoreDisplay();
                displayQuestion();
            }, 1000); 
        }

        // Check answer for text-input-components questions
        function checkTextInputAnswer(userInput, correctAnswer) {
            if (!quizActive) return; 
            quizActive = false; 

            totalQuestionsAttempted++;
            // Normalize user input: remove extra spaces, split by space, sort, join
            const normalizedUserInput = userInput.trim().toLowerCase().split(/\s+/).sort().join(' ');
            // Correct answer is already normalized in generateQuizQuestions
            const normalizedCorrectAnswer = correctAnswer;

            let isCorrect = (normalizedUserInput === normalizedCorrectAnswer);

            const inputField = answerButtonsContainer.querySelector('.answer-input');
            const submitButton = answerButtonsContainer.querySelector('.next-button');
            if (inputField) inputField.disabled = true;
            if (submitButton) submitButton.disabled = true;

            if (isCorrect) {
                score++;
                feedbackText.textContent = '✓ 正確！';
                feedbackText.classList.remove('incorrect-text');
                feedbackText.classList.add('correct-text');
            } else {
                // Correct answer needs to be displayed in proper case for user readability
                feedbackText.textContent = `✗ 不正確，正確答案是：${correctAnswer.split(' ').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')}`;
                feedbackText.classList.remove('correct-text');
                feedbackText.classList.add('incorrect-text');
            }

            // Auto-advance to next question after a short delay
            setTimeout(() => {
                currentQuestionIndex++;
                updateScoreDisplay();
                displayQuestion();
            }, 1000); 
        }


        // Update score display
        function updateScoreDisplay() {
            if (quizMode === 'matching') {
                scoreDisplay.textContent = `已配對: ${matchedPairsCount} / ${matchingGamePairs.length}`;
            } else {
                scoreDisplay.textContent = `分數: ${score} / ${totalQuestionsAttempted}`;
            }
        }

        // End the game
        function endGame() {
            quizActive = false;
            questionText.textContent = '測驗結束！';
            if (quizMode === 'matching') {
                feedbackText.textContent = `恭喜您，成功配對所有 ${matchingGamePairs.length} 組和弦！`;
            } else {
                feedbackText.textContent = `您總共答對了 ${score} 題，共 ${totalQuestionsAttempted} 題。`;
            }
            feedbackText.classList.remove('correct-text', 'incorrect-text');
            answerButtonsContainer.innerHTML = '';
            restartButton.classList.remove('hidden');
        }

        // Restart quiz
        restartButton.addEventListener('click', () => {
            feedbackText.textContent = '';
            if (quizMode === 'matching') {
                chordSelectionScreen.classList.remove('hidden');
                quizGameSection.classList.add('hidden');
                populateChordSelection(); // Repopulate checkboxes
            } else {
                keySelectionSection.classList.remove('hidden');
                quizGameSection.classList.add('hidden');
            }
            restartButton.classList.add('hidden');
            nextButton.classList.add('hidden');
            score = 0;
            totalQuestionsAttempted = 0;
            currentQuestionIndex = 0;
            matchedPairsCount = 0;
            selectedNumTile = null;
            selectedChordTile = null;
            selectedRootLettersForMixedMatching = [];
            updateScoreDisplay();
            quizActive = false;
            quizMode = ''; // Reset quiz mode
        });

        // Event listeners for key selection buttons
        keyButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const selectedKey = event.target.dataset.key;
                if (selectedKey === 'MixedMatchingGame') {
                    keySelectionSection.classList.add('hidden');
                    chordSelectionScreen.classList.remove('hidden');
                    populateChordSelection(); // Populate the checkboxes
                } else if (selectedKey === 'ChordComponentsQuiz') { // NEW MODE SELECTION
                    currentKey = selectedKey; // Set special key for this mode
                    quizMode = 'text-input-components';
                    currentQuestions = generateQuizQuestions(currentKey);
                    if (currentQuestions.length > 0) {
                        keySelectionSection.classList.add('hidden');
                        quizGameSection.classList.remove('hidden');
                        displayQuestion();
                        updateScoreDisplay();
                    } else {
                        questionText.textContent = "和弦組成音測驗題目不足。";
                        restartButton.classList.remove('hidden');
                    }
                } 
                else { // Standard key-based quizzes
                    currentKey = selectedKey;
                    quizMode = 'single-select'; 
                    currentQuestions = generateQuizQuestions(currentKey);
                    if (currentQuestions.length > 0) {
                        keySelectionSection.classList.add('hidden');
                        quizGameSection.classList.remove('hidden');
                        displayQuestion();
                        updateScoreDisplay();
                    } else {
                        questionText.textContent = "此調性目前沒有可用的測驗題目。";
                        restartButton.classList.remove('hidden');
                    }
                }
            });
        });

        // Event listener for Start Matching button
        startMixedMatchingButton.addEventListener('click', () => {
            selectedRootLettersForMixedMatching = Array.from(document.querySelectorAll('.chord-selection-checkbox:checked')).map(cb => cb.value);

            if (selectedRootLettersForMixedMatching.length === 0) {
                feedbackText.textContent = '請至少選擇一個和弦根音！';
                feedbackText.classList.add('incorrect-text');
                setTimeout(() => { feedbackText.textContent = ''; feedbackText.classList.remove('incorrect-text'); }, 2000);
                return;
            }
            selectedRootsDisplay.classList.remove('hidden'); // Show selected roots display
            startMatchingMode('MixedMatchingGame', selectedRootLettersForMixedMatching);
        });

        // Initial setup
        updateScoreDisplay();

    </script>
</body>
</html>
